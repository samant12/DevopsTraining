name: CI/CD Pipeline with Environments

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:

  # 1️⃣ Build Job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Project
        run: |
          echo "Building project..."
          mvn clean package
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: target/*.jar   # adjust according to your build output

  # 2️⃣ Deploy to Dev
  deploy-dev:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: dev   # Dev environment
      url: https://dev.example.com
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ./deploy

      - name: Deploy to Dev
        run: |
          echo "Deploying to Dev..."
          ls ./deploy
          # Add your real deployment commands here
          echo "Dev deployment completed!"

  # 3️⃣ Deploy to UAT
  deploy-uat:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment:
      name: uat            # UAT environment
      url: https://uat.example.com
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ./deploy

      - name: Deploy to UAT
        run: |
          echo "Deploying to UAT..."
          ls ./deploy
          # Add your real deployment commands here
          echo "UAT deployment completed!"

  # 4️⃣ Deploy to Prod (with manual approval)
  deploy-prod:
    runs-on: ubuntu-latest
    needs: deploy-uat
    environment:
      name: prod      # Prod environment
      url: https://prod.example.com
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ./deploy

      - name: Deploy to Prod
        run: |
          echo "Deploying to Production..."
          ls ./deploy
          # Add your real deployment commands here
          echo "Production deployment completed!"
